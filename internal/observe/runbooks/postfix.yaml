name: "Postfix mail server investigation"
type: postfix
aliases: [mail]
steps:
  - command: "systemctl status postfix 2>/dev/null || service postfix status 2>/dev/null || echo 'postfix service not found'"
    purpose: "check Postfix service status"
  - command: "postconf mail_version 2>/dev/null || echo 'postconf not available'"
    purpose: "identify Postfix version"
  - command: "mailq 2>/dev/null | tail -1 || echo 'mailq not available'"
    purpose: "check mail queue depth"
  - command: "postqueue -p 2>/dev/null | head -50 || echo 'postqueue not available'"
    purpose: "list queued messages with recipients and status"
  - command: "tail -100 {{SCOPE}}/mail.log 2>/dev/null || tail -100 {{SCOPE}}/maillog 2>/dev/null || journalctl -u postfix --no-pager -n 100 2>/dev/null || echo 'no mail logs found'"
    purpose: "show recent mail log entries"
  - command: "grep -i 'reject\\|bounced\\|deferred\\|error\\|warning' {{SCOPE}}/mail.log 2>/dev/null | tail -30 || grep -i 'reject\\|bounced\\|deferred\\|error\\|warning' {{SCOPE}}/maillog 2>/dev/null | tail -30 || echo 'no error patterns found'"
    purpose: "find recent delivery errors and bounces"
  - command: "postconf -n 2>/dev/null | grep -iE 'relay|transport|mydest|mynetworks|smtpd_recipient_restrictions|smtpd_sender_restrictions' || echo 'postconf not available'"
    purpose: "check relay and transport configuration"
  - command: "postconf -n 2>/dev/null | grep -iE 'tls|ssl|smtpd_use_tls|smtp_tls' || echo 'no TLS configuration found'"
    purpose: "check TLS configuration"
  - command: "ss -tlnp 2>/dev/null | grep -E ':25\\b|:587\\b|:465\\b' || netstat -tlnp 2>/dev/null | grep -E ':25\\b|:587\\b|:465\\b' || echo 'no SMTP ports listening'"
    purpose: "check SMTP listening ports (25, 587, 465)"
  - command: "find /var/spool/postfix/deferred/ -type f 2>/dev/null | wc -l || echo '0'"
    purpose: "count deferred messages"
